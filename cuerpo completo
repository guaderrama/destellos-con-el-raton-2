<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lienzo de Partículas Interactivo con Cámara</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background-color: #111827; /* bg-gray-900 */
        }
        canvas {
            display: block;
            background-color: #000;
        }
        .control-panel {
            background-color: #1f2937; /* bg-gray-800 */
            transition: transform 0.3s ease-in-out;
            z-index: 10;
            flex-shrink: 0; /* Evita que el panel se encoja */
        }
        .control-panel.hidden {
            transform: translateX(-100%);
        }
        .slider-label {
            color: #d1d5db; /* text-gray-300 */
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4b5563; /* bg-gray-600 */
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #06b6d4; /* bg-cyan-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #06b6d4; /* bg-cyan-500 */
            cursor: pointer;
            border-radius: 50%;
        }
        select {
            background-color: #4b5563;
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: white;
        }
    </style>
</head>
<body class="overflow-hidden h-screen flex">

    <!-- Panel de Control -->
    <div id="control-panel" class="control-panel w-full md:w-64 p-4 flex flex-col shadow-2xl overflow-y-auto">
        <h1 class="text-xl font-bold text-cyan-400 mb-4">Control de Partículas</h1>
        <p id="instructions" class="text-gray-400 mb-6 text-sm">Activa la cámara para empezar a interactuar con tu movimiento.</p>

        <div class="space-y-2 mb-6">
             <button id="camera-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-lg">
                Activar Cámara
            </button>
             <div id="status-message" class="mt-2 text-yellow-400 text-xs h-4"></div>
        </div>

        <div class="space-y-5">
            <!-- Controles de Color -->
            <div>
                <label for="colorMode" class="slider-label block mb-2 text-sm font-medium">Modo de Color</label>
                <select id="colorMode" class="w-full text-sm">
                    <option value="camera">Color de Cámara</option>
                    <option value="rainbow">Arcoíris</option>
                    <option value="thermal">Termal</option>
                    <option value="electric">Eléctrico</option>
                    <option value="fire">Fuego</option>
                    <option value="hue">Tono Fijo</option>
                </select>
            </div>
            <div id="hue-control" style="display: none;">
                <label for="hue" class="slider-label block mb-2 text-sm font-medium">Tono</label>
                <input id="hue" type="range" min="0" max="360" value="200" class="w-full">
            </div>

            <!-- Otros Controles -->
            <div>
                <label for="sensitivity" class="slider-label block mb-2 text-sm font-medium">Sensibilidad</label>
                <input id="sensitivity" type="range" min="10" max="100" value="30" class="w-full">
            </div>
            <div>
                <label for="particleCount" class="slider-label block mb-2 text-sm font-medium">Cantidad</label>
                <input id="particleCount" type="range" min="1" max="5" value="1" class="w-full">
            </div>
            <div>
                <label for="gravity" class="slider-label block mb-2 text-sm font-medium">Gravedad</label>
                <input id="gravity" type="range" min="-0.2" max="0.5" value="0.05" step="0.01" class="w-full">
            </div>
            <div>
                <label for="lifespan" class="slider-label block mb-2 text-sm font-medium">Duración</label>
                <input id="lifespan" type="range" min="20" max="200" value="60" class="w-full">
            </div>
             <div>
                <label for="trail" class="slider-label block mb-2 text-sm font-medium">Estela</label>
                <input id="trail" type="range" min="0.01" max="0.5" value="0.15" step="0.01" class="w-full">
            </div>
        </div>
         <div class="mt-auto pt-4">
            <p class="text-xs text-gray-500 text-center mb-2">Presiona 'H' para ocultar/mostrar</p>
            <button id="reset-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 shadow-lg">
                Limpiar Lienzo
            </button>
        </div>
    </div>

    <!-- Canvas y Video -->
    <div class="flex-1 relative">
        <canvas id="particle-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        <video id="webcam-feed" autoplay playsinline class="absolute top-0 left-0 w-1/4 h-auto opacity-20 border-2 border-gray-700 rounded-lg" style="display: none;"></video>
        <canvas id="hidden-canvas" style="display:none;"></canvas>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('webcam-feed');
        const hiddenCanvas = document.getElementById('hidden-canvas');
        const hiddenCtx = hiddenCanvas.getContext('2d');
        const controlPanel = document.getElementById('control-panel');

        const cameraButton = document.getElementById('camera-btn');
        const colorModeSelector = document.getElementById('colorMode');
        const hueControl = document.getElementById('hue-control');
        const hueSlider = document.getElementById('hue');
        const sensitivitySlider = document.getElementById('sensitivity');
        const particleCountSlider = document.getElementById('particleCount');
        const gravitySlider = document.getElementById('gravity');
        const lifespanSlider = document.getElementById('lifespan');
        const trailSlider = document.getElementById('trail');
        const resetButton = document.getElementById('reset-btn');
        const statusMessage = document.getElementById('status-message');
        const instructions = document.getElementById('instructions');

        let particles = [];
        let isCameraActive = false;
        let lastFrameData = null;
        const ANALYSIS_WIDTH = 128;
        let ANALYSIS_HEIGHT = 0;

        // --- CLASE PARTÍCULA ---
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + 2;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.color = color;
                this.lifespan = parseFloat(lifespanSlider.value);
            }

            update() {
                this.speedY += parseFloat(gravitySlider.value);
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.size > 0.2) this.size -= 0.1;
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // --- LÓGICA DE CÁMARA Y ANÁLISIS ---
        async function startCamera() {
            try {
                statusMessage.textContent = 'Accediendo a la cámara...';
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = 'block';
                cameraButton.textContent = 'Cámara Activa';
                cameraButton.disabled = true;
                instructions.textContent = '¡Muévete para crear arte! Ajusta los parámetros para cambiar el efecto.';
                statusMessage.textContent = '';
                isCameraActive = true;
            } catch (err) {
                console.error("Error al acceder a la cámara:", err);
                statusMessage.textContent = 'Error al acceder a la cámara.';
                instructions.textContent = 'No se pudo acceder a la cámara. Refresca la página para intentarlo de nuevo.';
            }
        }

        function processCameraFrame() {
            if (!isCameraActive || video.readyState < 2) return;

            if (ANALYSIS_HEIGHT === 0) {
                ANALYSIS_HEIGHT = Math.floor(ANALYSIS_WIDTH * (video.videoHeight / video.videoWidth));
                hiddenCanvas.width = ANALYSIS_WIDTH;
                hiddenCanvas.height = ANALYSIS_HEIGHT;
            }
            
            hiddenCtx.save();
            hiddenCtx.scale(-1, 1);
            hiddenCtx.drawImage(video, -ANALYSIS_WIDTH, 0, ANALYSIS_WIDTH, ANALYSIS_HEIGHT);
            hiddenCtx.restore();

            const currentFrame = hiddenCtx.getImageData(0, 0, ANALYSIS_WIDTH, ANALYSIS_HEIGHT);
            const data = currentFrame.data;

            if (lastFrameData) {
                const sensitivity = parseInt(sensitivitySlider.value);
                const particleCount = parseInt(particleCountSlider.value);
                const colorMode = colorModeSelector.value;
                const hue = hueSlider.value;

                for (let i = 0; i < data.length; i += 4) {
                    const currentBrightness = (data[i] + data[i+1] + data[i+2]) / 3;
                    const lastBrightness = (lastFrameData.data[i] + lastFrameData.data[i+1] + lastFrameData.data[i+2]) / 3;
                    
                    if (Math.abs(currentBrightness - lastBrightness) > sensitivity) {
                        const pixelIndex = i / 4;
                        const x = (pixelIndex % ANALYSIS_WIDTH) / ANALYSIS_WIDTH * canvas.width;
                        const y = Math.floor(pixelIndex / ANALYSIS_WIDTH) / ANALYSIS_HEIGHT * canvas.height;
                        
                        let color;
                        switch (colorMode) {
                            case 'rainbow':
                                color = `hsl(${Math.random() * 360}, 100%, 70%)`;
                                break;
                            case 'hue':
                                color = `hsl(${hue}, 100%, 70%)`;
                                break;
                            case 'thermal':
                                const thermalHue = 240 - (currentBrightness / 255) * 240;
                                color = `hsl(${thermalHue}, 100%, 50%)`;
                                break;
                            case 'electric':
                                const electricColors = ['#00ffff', '#ffffff', '#00aaff'];
                                color = electricColors[Math.floor(Math.random() * electricColors.length)];
                                break;
                            case 'fire':
                                const fireColors = ['#ffdd00', '#ff8800', '#ff0000', '#ffff00'];
                                color = fireColors[Math.floor(Math.random() * fireColors.length)];
                                break;
                            case 'camera':
                            default:
                                color = `rgb(${data[i]}, ${data[i+1]}, ${data[i+2]})`;
                                break;
                        }

                        for(let j = 0; j < particleCount; j++) {
                           particles.push(new Particle(x, y, color));
                        }
                    }
                }
            }
            lastFrameData = currentFrame;
        }

        // --- BUCLE PRINCIPAL Y GESTIÓN ---
        function handleParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].lifespan <= 0 || particles[i].size <= 0.2) {
                    particles.splice(i, 1);
                }
            }
        }
        
        function animate() {
            ctx.fillStyle = `rgba(0, 0, 0, ${trailSlider.value})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (isCameraActive) {
                processCameraFrame();
            }
            handleParticles();
            
            requestAnimationFrame(animate);
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('resize', resizeCanvas);
        cameraButton.addEventListener('click', startCamera);
        resetButton.addEventListener('click', () => {
            particles = [];
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        });

        colorModeSelector.addEventListener('change', (e) => {
            hueControl.style.display = (e.target.value === 'hue') ? 'block' : 'none';
        });

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'h') {
                controlPanel.classList.toggle('hidden');
            }
        });

        // --- INICIALIZACIÓN ---
        resizeCanvas();
        animate();
    </script>
</body>
</html>
